<%- include('./partials/header.ejs') %>
    <nav>
        <h1>Secret</h1>
        <h3></h3>
        <a href="/logout" class="btn btn-light">Log-out</a>
    </nav>
    <div class="box container">
        <h2>Share your secrets here</h2>
        <div class="noSecretBox"></div>
        <ul class="secrets">

        </ul>
        <form id="secretForm">
            <input id="secretTxt" type="text" placeholder="Enter secrets" name="secretTxt" class="form-control">
            <input type="submit" value="Enter" class="btn btn-success">
        </form>
    </div>
    <script>
        const apiUrl = 'http://localhost:3000/secrets'
        const userUrl = 'http://localhost:3000'
        const secrets = document.querySelector('.secrets')
        const noScretBox = document.querySelector('.noSecretBox')
        const name = document.querySelector('nav h3')
        let userLinkToId = ''
        // get data
        const getSecret = async () => {
            const res = await fetch(apiUrl, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            })

            const data = await res.json()
            userLinkToId = data.user.userId
            secrets.innerHTML = ``
            noScretBox.innerHTML = ''
            if (typeof data.message != 'undefined') {
                noScretBox.innerHTML = `<h4>${data.message}</h4>`
            }
            if (data != '') {
                name.innerText = data.user.username
                data.secrets.forEach((secret,index) => {
                    secrets.innerHTML += `<li><span>${secret.secretTxt}</span></li>`
                    if(secret.linkTo == userLinkToId){
                        document.querySelectorAll('ul li')[index].style.textAlign = 'right'
                        document.querySelectorAll('ul li span')[index].classList.add('loginUser')
                    }
                })
            }
        }
        getSecret()
        // submit form
        document.querySelector('form').addEventListener('submit', async (e) => {
            let secretTxt = document.querySelector('#secretTxt')

            e.preventDefault()
            const res = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ secretTxt: secretTxt.value, linkTo:userLinkToId})
            })
            secretTxt.value = ''
            if (res.ok) {
                getSecret()
            } else {
                console.log('response not ok')
            }
        })
    </script>
    </body>

    </html>